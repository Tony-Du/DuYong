<workflow-app xmlns='uri:oozie:workflow:0.1' name='rd_order_user'>

	<start to="fork_user_bill_order_join" />
	
	<!--<join name="join_user_bill_order_join" to="XXXX" />-->
	<fork name="fork_user_bill_order_join">
		<path start="use_bill_detail" />
		<path start="order_detail" />
	</fork>

	<!-- user_bill_detail: 
	STATIS_MONTH, SERV_NUMBER, PRODUCT_ID,
	BILL_TIME, CP_ID, CHARGE_TYPE, BILL_FEE, CONTENT_ID, USE_DUR , USE_FLOW, OPT_TYPE , PROGRAM_ID, PROGRAM_FATHER_ID, TERM_PROD_ID, PROV_ID, REGION_ID, LEDGER_TYPE, CHN_ID_NEW
	-->
	<action name="use_bill_detail">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/use_bill_detail" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>prep_seperate_tool</arg>
			<arg>srcSep=|</arg>
			<arg>tgtSep=TAB</arg>
			<arg>redNum=58</arg>
			<arg>outpath=${outputTmp}/use_bill_detail</arg>
			
			<arg>inpath=${internal_input}/bill/${year_month}</arg>
			<arg>mapCols=STATIS_MONTH, SERV_NUMBER, BILL_TIME, CP_ID, CHARGE_TYPE, BILL_FEE, PRODUCT_ID, CONTENT_ID, USE_DUR , USE_FLOW, OPT_TYPE , PROGRAM_ID, PROGRAM_FATHER_ID, TERM_PROD_ID, PROV_ID, REGION_ID, LEDGER_TYPE, CHN_ID_NEW, NOT_USED</arg>
			<arg>mapKeys=STATIS_MONTH, SERV_NUMBER, PRODUCT_ID</arg>
			<arg>mapVals=BILL_TIME, CP_ID, CHARGE_TYPE, BILL_FEE, CONTENT_ID, USE_DUR , USE_FLOW, OPT_TYPE , PROGRAM_ID, PROGRAM_FATHER_ID, TERM_PROD_ID, PROV_ID, REGION_ID, LEDGER_TYPE, CHN_ID_NEW</arg>
			
			<capture-output />
		</java>
		<ok to="join_user_bill_order_join" />
		<error to="fail" />
	</action>
	
	<!-- user_bill_detail: 
	USER_ID, PRODUCT_ID
	-->
	<action name="order_detail">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/order_detail" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>prep_seperate_tool</arg>
			<arg>srcSep=|</arg>
			<arg>tgtSep=TAB</arg>	
			<arg>outpath=${outputTmp}/order_detail</arg>
			
			<arg>inpath=${internal_input}/order/${year_month}</arg>
			<arg>mapCols=STATIS_DAY, USER_ID, PRODUCT_ID, FIRST_ORDER_TIME, LAST_ORDER_TIME, ORDER_STATUS, SUB_ORDER_STATUS, TERM_PROD_ID, PROV_ID, REGION_ID, CHN_ID_NEW, OPERATOR, NATIVE, ORDER_BILL, CONTENT_ID, CONTENT_NODE, LEDGER_TYPE, SERVICE_TYPE</arg>
			<arg>mapKeys=USER_ID</arg>
			<arg>mapVals=PRODUCT_ID</arg>
			
			<capture-output />
		</java>
		<ok to="join_user_bill_order_join" />
		<error to="fail" />
	</action>
	
	
	<join name="join_user_bill_order_join" to="order_user_number" />
	
	<!-- Merge User & Tourist Page Bill info OUTPUT_COLS : 
	USER_NUM, USER_ID, COUNTER
	-->
	<action name="tdim_userid_usernum">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/tdim_userid_usernum" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_userid_usernum_tool</arg>
			<arg>outpath=${outputTmp}/tdim_userid_usernum</arg>
			
			<arg>inpath=${cdmpPath}/td_userid_usernum</arg>
			
			<arg>mapKeys= USER_NUM, USER_ID</arg>
			<arg>mapVals= NUM:1</arg>
			<arg>redVals= SUM:1</arg>
			<capture-output />
		</java>
		<ok to="end" />
		<error to="fail" />
	</action>

	<!--order_user_number : 
	${outputTmp}/order_user_number
	USER_ID, PRODUCT_ID, USER_NUM
	-->
	<action name="order_user_number">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/order_user_number" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>map_join_tool</arg>
			
			<arg>outpath=${outputTmp}/order_user_number</arg>
			
			<arg>inpath=${outputTmp}/order_detail</arg>
			<arg>inpathR=${outputTmp}/tdim_userid_usernum</arg>

			<arg>mapCols=USER_ID, PRODUCT_ID</arg>
			<arg>mapKeys=USER_ID</arg>
			<arg>mapVals=PRODUCT_ID</arg>
			
			<arg>mapRCols=USER_NUM, USER_ID, COUNTER
			</arg>
			<arg>mapRKeys=USER_ID</arg>
			<arg>mapRVals=USER_NUM</arg>
			<capture-output />
		</java>
		<ok to="order_user_bill" />
		<error to="fail" />
	</action>
	
	<!--order_user_bill : 
	${outputTmp}/order_user_bill
	USER_NUM, PRODUCT_ID, USER_ID,
	STATIS_MONTH, BILL_TIME, CP_ID, CHARGE_TYPE, BILL_FEE, CONTENT_ID, USE_DUR , USE_FLOW, OPT_TYPE , PROGRAM_ID, PROGRAM_FATHER_ID, TERM_PROD_ID, PROV_ID, REGION_ID, LEDGER_TYPE, CHN_ID_NEW
	-->
	<action name="order_user_bill">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/order_user_bill" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>map_join_tool</arg>
			
			<arg>outpath=${outputTmp}/order_user_bill</arg>
			
			<arg>inpath=${outputTmp}/order_user_number</arg>
			<arg>inpathR=${outputTmp}/use_bill_detail</arg>

			<arg>mapCols= USER_ID, PRODUCT_ID, USER_NUM</arg>
			<arg>mapKeys=USER_NUM, PRODUCT_ID</arg>
			<arg>mapVals=USER_ID</arg>
			
			<arg>mapRCols=STATIS_MONTH, SERV_NUMBER, PRODUCT_ID,BILL_TIME, CP_ID, CHARGE_TYPE, BILL_FEE, CONTENT_ID, USE_DUR , USE_FLOW, OPT_TYPE , PROGRAM_ID, PROGRAM_FATHER_ID, TERM_PROD_ID, PROV_ID, REGION_ID, LEDGER_TYPE, CHN_ID_NEW
			</arg>
			<arg>mapRKeys=SERV_NUMBER, PRODUCT_ID</arg>
			<arg>mapRVals=STATIS_MONTH, BILL_TIME, CP_ID, CHARGE_TYPE, BILL_FEE, CONTENT_ID, USE_DUR , USE_FLOW, OPT_TYPE , PROGRAM_ID, PROGRAM_FATHER_ID, TERM_PROD_ID, PROV_ID, REGION_ID, LEDGER_TYPE, CHN_ID_NEW</arg>
			<capture-output />
		</java>
		<ok to="sort_order_user_bill" />
		<error to="fail" />
	</action>
	
	
	<!--sort_order_user_bill : 
	STATIS_MONTH, SERV_NUMBER,
	BILL_TIME, CP_ID, CHARGE_TYPE, BILL_FEE, PRODUCT_ID, CONTENT_ID, USE_DUR , USE_FLOW, 
	OPT_TYPE , PROGRAM_ID, PROGRAM_FATHER_ID, TERM_PROD_ID, PROV_ID, REGION_ID, LEDGER_TYPE, CHN_ID_NEW
	-->
	<action name="sort_order_user_bill">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>prep_seperate_tool</arg>
			<arg>redNum=1</arg>
			<arg>srcSep=TAB</arg>
			<arg>tgtSep=|</arg>	
			<arg>outpath=${outputPath}/${year_month}</arg>
			
			<arg>inpath=${outputTmp}/order_user_bill</arg>

			
			<arg>mapCols= USER_NUM, PRODUCT_ID, USER_ID, STATIS_MONTH, BILL_TIME, CP_ID, CHARGE_TYPE, BILL_FEE, CONTENT_ID, USE_DUR , USE_FLOW, OPT_TYPE , PROGRAM_ID, PROGRAM_FATHER_ID, TERM_PROD_ID, PROV_ID, REGION_ID, LEDGER_TYPE, CHN_ID_NEW
			</arg>
				
			<arg>mapKeys= STATIS_MONTH, USER_ID</arg>
			<arg>mapVals= BILL_TIME NULL EMPTY, CP_ID NULL EMPTY, CHARGE_TYPE NULL EMPTY, BILL_FEE NULL EMPTY, PRODUCT_ID NULL EMPTY, CONTENT_ID NULL EMPTY, USE_DUR NULL EMPTY, USE_FLOW NULL EMPTY, OPT_TYPE NULL EMPTY, PROGRAM_ID NULL EMPTY, PROGRAM_FATHER_ID NULL EMPTY, TERM_PROD_ID NULL EMPTY, PROV_ID NULL EMPTY, REGION_ID NULL EMPTY, LEDGER_TYPE NULL EMPTY, CHN_ID_NEW NULL EMPTY</arg>
	
			<capture-output />
		</java>
		<ok to="end" />
		<error to="fail" />
	</action>
	


	<action name="cleanTempData">
		<fs>
			<delete path="${outputTmp}" />
		</fs>
		<ok to="end" />
		<error to="end" />
	</action>

	<kill name="fail">
		<message>Failed, error message[${wf:errorMessage(wf:lastErrorNode())}]
		</message>
	</kill>

	<end name="end" />
</workflow-app>
