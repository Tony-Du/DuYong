<workflow-app xmlns='uri:oozie:workflow:0.1' name='internet_dep_recom_page_common'>

	<!-- 
	/user/hadoop/public/migu_analyo_ly/output/dep_internet/common/td_aaa_bill_d/${YEAR}${MONTH}${DAY} 
		COL:STATIS_DAY, COL:SERV_NUMBER, COL:CONTENT_ID, COL:PROGRAM_ID, COL:TERM_PROD_ID
		COL:USE_DUR, COL:USE_FLOW, COL:USE_PV 
	/user/hadoop/public/migu_analyo_ly/output/dep_internet/common/td_aaa_tourist_bill_d/${YEAR}${MONTH}${DAY} 
		COL:STATIS_DAY, COL:SERV_NUMBER, COL:CONTENT_ID, COL:PROGRAM_ID, COL:TERM_PROD_ID
		COL:USE_DUR, COL:USE_FLOW, COL:USE_PV 
	/user/hadoop/public/migu_analyo_ly/output/dep_internet/common/td_pub_visit_log_d/${YEAR}${MONTH}${DAY} 
		COL:STATIS_DAY, COL:SERV_NUMBER, COL:PAGE_ID, COL:SUP_POSE_ID, COL:TERM_PROD_ID, COL:NODE_ID, COL:VISIT_PV
	/user/hadoop/public/migu_analyo_ly/output/dep_internet/common/td_pub_tourist_visit_log_d/${YEAR}${MONTH}${DAY} 
		COL:STATIS_DAY, COL:TOURIST_VISIT_ID, COL:PAGE_ID, COL:SUP_POSE_ID, COL:TERM_PROD_ID, COL:NODE_ID, COL:VISIT_PV

	/user/hadoop/public/migu_analyo_ly/output/dep_internet/common/to_page_pose_d/${YEAR}${MONTH}${DAY} 
		COL:PAGE_ID, COL:PAGE_NAME, COL:SHOW_OBJ_ID 
		
	-->

	<start to="to_voms_show_obj_d_detail" />

	
	
	<!--
	<join name="join_common_data_generate" to=" " />
	-->
	<fork name="fork_common_data_generate"> 
		<path start="user_bill_detail" />
		<path start="tourist_bill_detail" />
		<path start="user_visit_detail" />
		<path start="tourist_visit_detail" />
		<path start="to_voms_show_obj_d_detail" />
	</fork>

	<!-- user_bill_detail: 
	COL:STATIS_DAY, COL:SERV_NUMBER, COL:CONTENT_ID, COL:PROGRAM_ID, COL:TERM_PROD_ID
	COL:USE_DUR, COL:USE_FLOW, COL:PV
	-->
	<action name="user_bill_detail">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_aaa_bill_d_tool</arg>
			<arg>inDate= ${startDate}</arg>
			<arg>outDate= ${startDate}</arg>
			<arg>redNum=1</arg>
			<arg>inpath=${cdmpPath}/td_aaa_bill_d</arg>
			<arg>outpath=${outputPath}/td_aaa_bill_d</arg>
			<arg>mapKeys=COL:STATIS_DAY, COL:SERV_NUMBER, COL:CONTENT_ID, COL:PROGRAM_ID, COL:TERM_PROD_ID</arg>
			<arg>mapVals=COL:USE_DUR, COL:USE_FLOW, NUM:1</arg>
			<arg>redVals=CNT:USE_DUR, CNT:USE_FLOW, CNT:1</arg>
			<capture-output />
		</java>
		<ok to="join_common_data_generate" />
		<error to="fail" />
	</action>
	<!-- End User Page Bill info -->



	<!-- tourist_bill_detail: 
	COL:STATIS_DAY, COL:SERV_NUMBER, COL:CONTENT_ID, COL:PROGRAM_ID, COL:TERM_PROD_ID
	COL:USE_DUR, COL:USE_FLOW, COL:PV
	-->
	<action name="tourist_bill_detail">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_aaa_tourist_bill_d_tool</arg>
			<arg>redNum=1</arg>
			<arg>inDate= ${startDate}</arg>
			<arg>outDate= ${startDate}</arg>
			<arg>inpath=${cdmpPath}/td_aaa_tourist_bill_d</arg>
			<arg>outpath=${outputPath}/td_aaa_tourist_bill_d</arg>
			<arg>mapKeys=COL:STATIS_DAY, COL:SERV_NUMBER, COL:CONTENT_ID, COL:PROGRAM_ID, COL:TERM_PROD_ID</arg>
			<arg>mapVals=COL:USE_DUR, COL:USE_FLOW, NUM:1</arg>
			<arg>redVals=CNT:USE_DUR, CNT:USE_FLOW, CNT:1</arg>
			<capture-output />
		</java>
		<ok to="join_common_data_generate" />
		<error to="fail" />
	</action>
	
	
	<!-- user_visit_detail: 
	COL:STATIS_DAY, COL:SERV_NUMBER, 
	COL:PAGE_ID, COL:SUP_POSE_ID, COL:TERM_PROD_ID, COL:PV 
	-->
	<action name="user_visit_detail">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_pub_visit_log_d_tool</arg>
			<arg>inDate= ${startDate}</arg>
			<arg>outDate= ${startDate}</arg>
			<arg>redNum=1</arg>
			<arg>inpath=${cdmpPath}/td_pub_visit_log_d</arg>
			<arg>outpath=${outputPath}/td_pub_visit_log_d</arg>
			<arg>mapKeys=COL:STATIS_DAY, COL:SERV_NUMBER, COL:PAGE_ID,
				COL:SUP_POSE_ID, COL:TERM_PROD_ID, COL:NODE_ID</arg>
			<arg>mapVals=NUM:1</arg>
			<arg>redVals=CNT:1</arg>
			<capture-output />
		</java>
		<ok to="join_common_data_generate" />
		<error to="fail" />
	</action>
	<!-- End User Page Visit info -->

	<!-- tourist_visit_detail: 
	COL:STATIS_DAY, COL:SERV_NUMBER, 
	COL:PAGE_ID, COL:SUP_POSE_ID, COL:TERM_PROD_ID, COL:PV 
	-->
	<action name="tourist_visit_detail">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_pub_visit_log_wd_tourist_d_tool</arg>
			<arg>inDate= ${startDate}</arg>
			<arg>outDate= ${startDate}</arg>
			<arg>redNum=1</arg>
			<arg>inpath=${cdmpPath}/td_pub_tourist_visit_log_d</arg>
			<arg>outpath=${outputPath}/td_pub_tourist_visit_log_d</arg>
			<arg>mapKeys= COL:STATIS_DAY, COL:TOURIST_VISIT_ID, COL:PAGE_ID,
				COL:SUP_POSE_ID, COL:TERM_PROD_ID, COL:NODE_ID</arg>
			<arg>mapVals= NUM:1</arg>
			<arg>redVals= CNT:1</arg>
			<capture-output />
		</java>
		<ok to="join_common_data_generate" />
		<error to="fail" />
	</action>
	
	
	<!-- join_k_page_v_pose: 
	COL:SUP_NODE_ID,
	COL:SHOW_OBJ_ID
	-->
	<action name="to_voms_show_obj_d_detail">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/to_voms_show_obj_d_detail" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>ods_to_voms_show_obj_d_tool</arg>
			
			<arg>inDate= ${startDate}</arg>
			
			<arg>outpath=${outputTmp}/to_voms_show_obj_d_detail</arg>
			
			<arg>inpath=${cdmpPath}/to_voms_show_obj_d</arg>
			
			<arg>mapKeys=COL:SUP_NODE_ID</arg>
			<arg>mapVals=COL:SHOW_OBJ_ID</arg>
			<capture-output />
		</java>
		<ok to="to_page_pose_d" />
		<error to="fail" />
	</action>
	

	<!-- join_k_page_v_pose: 
	COL:PAGE_ID, COL:PAGE_NAME, COL:SHOW_OBJ_ID
	
	-->
	<action name="to_page_pose_d">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>map_join_tool</arg>			
			<arg>redNum=1</arg>
			
			<arg>outDate= ${startDate}</arg>
			
			<arg>outpath=${outputPath}/to_page_pose_d</arg>
			
			<arg>inpath=${td_dep_internet_page_info}</arg>
			<arg>inpathR=${outputTmp}/to_voms_show_obj_d_detail</arg>

			<arg>mapCols=COL:PAGE_ID, COL:PAGE_NAME</arg>
			<arg>mapKeys=COL:PAGE_ID</arg>
			<arg>mapVals=COL:PAGE_NAME</arg>

			<arg>mapRCols=COL:SUP_NODE_ID, COL:SHOW_OBJ_ID</arg>
			<arg>mapRKeys=COL:SUP_NODE_ID</arg>
			<arg>mapRVals=COL:SHOW_OBJ_ID</arg>
			<capture-output />
		</java>
		<!--<ok to="join_common_data_generate" />-->
		<ok to="end" />
		<error to="fail" />
	</action>

	

	<!-- End Tourist Page Visit info -->
	<join name="join_common_data_generate" to="cleanTempData" />


	<action name="cleanTempData">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>cmd_del_path</arg>
			<arg>inpath=${outputTmp}</arg>
			<capture-output />
		</java>
		<ok to="end" />
		<error to="end" />
	</action>

	<kill name="fail">
		<message>Failed, error message[${wf:errorMessage(wf:lastErrorNode())}]
		</message>
	</kill>

	<end name="end" />
</workflow-app>
