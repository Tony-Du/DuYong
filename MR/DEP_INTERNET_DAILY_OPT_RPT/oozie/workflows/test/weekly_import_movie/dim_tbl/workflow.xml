<workflow-app xmlns='uri:oozie:workflow:0.5' name='weekly_import_content_dim_tbl'>
	
	<!-- tdim_term_videotype 
	${outputTmp}/tdim_term_videotype	
	 TERM_PROD_ID, TERM_VIDEO_TYPE_ID
	-->
	
	<!--tdim_cont_name_sincon_prog : 
	${outputTmp}/tdim_cont_name_sincon_prog
	 CONTENT_ID, CONTENT_NAME, SIN_CONTENT_ID, PROGRAM_ID
	-->
	
	
	<start to="dim_tables" />
		
	<!-- 
	<join name="join_dim_tables" to="XXXXXX" />
	-->
	<fork name="dim_tables">
		<path start="tdim_term_videotype" />
		<path start="tdim_program_content" />
		<path start="tdim_contet_sincont" />
		<path start="tdim_content_contclassname" />
		<path start="tdim_content_contattriname" />
		<path start="tdim_content_contname" />
	</fork>
	
	<!-- tdim_term_videotype 
	${outputTmp}/tdim_term_videotype	
	 TERM_PROD_ID, TERM_VIDEO_TYPE_ID
	-->
	<action name="tdim_term_videotype">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/tdim_term_videotype" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>tdim_prod_id_tool</arg>
			<arg>redNum=1</arg>
			
			<arg>outpath=${outputTmp}/tdim_term_videotype</arg>
			
			<arg>inpath=${cdmpPath}/tdim_prod_id</arg>
			<arg>mapKeys= TERM_PROD_ID</arg>
			<arg>mapVals=APPFILTER:MG_ShiPin|MG_HeShiPin</arg>
			<arg>redVals= COL:MG_ShiPin|MG_HeShiPin</arg>
			<capture-output />
		</java>
		<ok to="join_dim_tables" />
		<error to="fail" />
	</action>
	
	
	<!-- tdim_program_content 
	${outputTmp}/tdim_program_content	
	 PROGRAM_ID, CONTENT_ID
	-->
	<action name="tdim_program_content">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/tdim_program_content" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_oms_program_d_tool</arg>
			<arg>redNum=1</arg>
			
			<arg>outpath=${outputTmp}/tdim_program_content</arg>
			
			<arg>inpath=${cdmpPath}/td_oms_program_d</arg>
			<arg>mapKeys= PROGRAM_ID</arg>
			<arg>mapVals= CONTENT_ID</arg>
			
			<capture-output />
		</java>
		<ok to="join_dim_tables" />
		<error to="fail" />
	</action>
	
	
	<!-- tdim_term_videotype 
	${outputTmp}/tdim_contet_sincont
	 CONTENT_ID, SIN_CONTENT_ID
	-->
	<action name="tdim_contet_sincont">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/tdim_contet_sincont" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>			
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_icms_drama_sin_rel_tool</arg>
			<arg>redNum=1</arg>
			
			<arg>outpath=${outputTmp}/tdim_contet_sincont</arg>
			
			<arg>inpath=${cdmpPath}/td_icms_drama_sin_rel</arg>
			<arg>mapKeys= DRAMA_CONTENT_ID</arg>
			<arg>mapVals= SIN_CONTENT_ID</arg>
			
			<capture-output />
		</java>
		<ok to="join_dim_tables" />
		<error to="fail" />
	</action>
	
	
	<!-- tdim_content_contclassname 
	${outputTmp}/tdim_content_contclassname
	 CONTENT_ID, CON_CLASS_1_NAME
	-->
	<action name="tdim_content_contclassname">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/content_class/tdim_content_contclassname" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>			
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_cms_content_class_d_tool</arg>
			<arg>redNum=1</arg>
			
			<arg>outpath=${outputTmp}/content_class/tdim_content_contclassname</arg>
			
			<arg>inpath=${cdmpPath}/td_cms_content_class_d</arg>
			<arg>mapKeys= CONTENT_ID</arg>
			<arg>mapVals= CON_CLASS_1_NAME MOVIE|TV|VARIETY|CARTOON</arg>
			
			<capture-output />
		</java>
		<ok to="join_dim_tables" />
		<error to="fail" />
	</action>
	
	
	<!-- tdim_content_contattriname 
	${outputTmp}/tdim_content_contattriname
	 CONTENT_ID, CON_CLASS_1_NAME
	-->
	<action name="tdim_content_contattriname">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/content_class/tdim_content_contattriname" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>			
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_cms_content_attr_d_tool</arg>
			<arg>redNum=1</arg>
			
			<arg>outpath=${outputTmp}/content_class/tdim_content_contattriname</arg>
			
			<arg>inpath=${cdmpPath}/td_cms_content_attr_d</arg>
			<arg>mapKeys= CONTENT_ID</arg>
			<arg>mapVals= CON_CLASS_1_NAME MOVIE|TV|VARIETY|CARTOON</arg>
			
			<capture-output />
		</java>
		<ok to="join_dim_tables" />
		<error to="fail" />
	</action>
	
	
	
	<!-- tdim_content_contname 
	${outputTmp}/tdim_content_contclassname
	 CONTENT_ID, CONTENT_NAME
	-->
	<action name="tdim_content_contname">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/tdim_content_contname" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>			
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>td_cms_content_d_tool</arg>
			<arg>redNum=1</arg>
			
			<arg>outpath=${outputTmp}/tdim_content_contname</arg>
			
			<arg>inpath=${cdmpPath}/td_cms_content_d</arg>
			<arg>mapKeys=CONTENT_ID</arg>
			<arg>mapVals=CONTENT_NAME</arg>
			
			<capture-output />
		</java>
		<ok to="join_dim_tables" />
		<error to="fail" />
	</action>
	
	<join name="join_dim_tables" to="tdim_cont_contclassnm_sincont" />
	
	
	<!--OUTPUT_COLS : 
	 CONTENT_ID, 
	 CON_CLASS_1_NAME, 
	 SIN_CONTENT_ID
	-->
	<action name="tdim_cont_contclassnm_sincont">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/tdim_cont_contclassnm_sincont" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>map_join_tool</arg>
			
			<arg>outpath=${outputTmp}/tdim_cont_contclassnm_sincont</arg>
			
			<arg>inpath=${outputTmp}/content_class</arg>
			<arg>inpathR=${outputTmp}/tdim_contet_sincont</arg>
			
			<arg>mapCols=CONTENT_ID, CON_CLASS_1_NAME</arg>
			<arg>mapKeys=CONTENT_ID</arg>
			<arg>mapVals=CON_CLASS_1_NAME</arg>
			
			<arg>mapRCols=DRAMA_CONTENT_ID, SIN_CONTENT_ID</arg>
				
			<arg>mapRKeys=DRAMA_CONTENT_ID</arg>
			<arg>mapRVals=SIN_CONTENT_ID</arg>
			
			<capture-output />
		</java>
		<ok to="tdim_sincon_cont_prog" />
		<error to="fail" />
	</action>
	
	<!--OUTPUT_COLS : 
	 SIN_CONTENT_ID, 
	 CONTENT_ID, 
	 PROGRAM_ID
	-->
	<action name="tdim_sincon_cont_prog">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/tdim_sincon_cont_prog" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>map_join_tool</arg>
			
			<arg>outpath=${outputTmp}/tdim_sincon_cont_prog</arg>
			
			<arg>inpath=${outputTmp}/tdim_contet_sincont</arg>
			<arg>inpathR=${outputTmp}/tdim_program_content</arg>
			
			<arg>mapCols=CONTENT_ID, SIN_CONTENT_ID</arg>
			<arg>mapKeys=SIN_CONTENT_ID</arg>
			<arg>mapVals=CONTENT_ID</arg>
			
			<arg>mapRCols=PROGRAM_ID, SIN_CONTENT_ID</arg>				
			<arg>mapRKeys=SIN_CONTENT_ID</arg>
			<arg>mapRVals=PROGRAM_ID</arg>
			
			<capture-output />
		</java>
		<ok to="tdim_cont_name_sincon_prog" />
		<error to="fail" />
	</action>
	
	
	<!--tdim_cont_name_sincon_prog : 
	${outputTmp}/tdim_cont_name_sincon_prog
	 CONTENT_ID, 
	 CONTENT_NAME, 
	 SIN_CONTENT_ID, PROGRAM_ID
	-->
	<action name="tdim_cont_name_sincon_prog">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/tdim_cont_name_sincon_prog" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>inner_join_tool</arg>
			
			<arg>outpath=${outputTmp}/tdim_cont_name_sincon_prog</arg>
			
			<arg>inpath=${outputTmp}/tdim_content_contname</arg>
			<arg>inpathR=${outputTmp}/tdim_sincon_cont_prog</arg>
			
			<arg>mapCols=CONTENT_ID, CONTENT_NAME</arg>				
			<arg>mapKeys=CONTENT_ID</arg>
			<arg>mapVals=CONTENT_NAME</arg>
			
			<arg>mapRCols=SIN_CONTENT_ID, CONTENT_ID, PROGRAM_ID</arg>
			<arg>mapRKeys=CONTENT_ID</arg>
			<arg>mapRVals=SIN_CONTENT_ID, PROGRAM_ID</arg>
			
			
			<capture-output />
		</java>
		<ok to="end" />
		<error to="fail" />
	</action>
	
	<kill name="fail">
		<message>Failed, error message[${wf:errorMessage(wf:lastErrorNode())}]
		</message>
	</kill>

	<end name="end" />
</workflow-app>
