<workflow-app xmlns='uri:oozie:workflow:0.1' name='weekly_import_content_use_visit'>

	<start to="subworkflow-dim_tbl" />
	
	
	<!-- tdim_term_videotype 
	${outputTmp}/tdim_term_videotype	
	 TERM_PROD_ID, TERM_VIDEO_TYPE_ID
	-->
	
	<!--tdim_cont_name_sincon_prog : 
	${outputTmp}/tdim_cont_name_sincon_prog
	 CONTENT_ID, CONTENT_NAME, SIN_CONTENT_ID, PROGRAM_ID
	-->
	
    <action name="subworkflow-dim_tbl">
        <sub-workflow>
            <app-path>${nameNode}/user/hadoop/public/migu_analyo_ly/oozie/workflows/test/weekly_import_movie/dim_tbl</app-path>
			<propagate-configuration/>
        </sub-workflow>
        <ok to="subworkflow-use_visit_tbl"/>
        <error to="fail"/>
    </action>
	
	<!-- ${outputTmp}/usr_bill_detail
	COL:STATIS_DAY, COL:CONTENT_ID, COL:PROGRAM_ID, COL:TERM_PROD_ID, COL:USE_DUR,  COL:USE_UV, COL:USE_PV
	-->
	
	<!-- tourist_bill_detail
	${outputTmp}/tourist_bill_detail
	COL:STATIS_DAY, COL:CONTENT_ID, COL:PROGRAM_ID, COL:TERM_PROD_ID, COL:USE_DUR, COL:USE_UV, COL:USE_PV
	-->
	
	<!-- usr_visit_detail:
	${outputTmp}/usr_visit_detail
	COL:STATIS_DAY, COL:NODE_ID, COL:TERM_PROD_ID, COL:VISIT_UV , COL:VISIT_PV
	-->	
	
	<!-- tourist_visit_detail: 
	${outputTmp}/tourist_visit_detail
	COL:STATIS_DAY, COL:NODE_ID, COL:TERM_PROD_ID, COL:VISIT_UV , COL:VISIT_PV
	-->
	
	<action name="subworkflow-use_visit_tbl">
        <sub-workflow>
            <app-path>${nameNode}/user/hadoop/public/migu_analyo_ly/oozie/workflows/test/weekly_import_movie/use_visit_tbl</app-path>
			<propagate-configuration/>
        </sub-workflow>
        <ok to="subworkflow-use_visit_contet_term"/>
        <error to="fail"/>
    </action>
	
	
	<!-- Merge content_use_visit 
	${outputTmp}/content_use_visit
	 STATIS_DAY, CONTENT_ID, CONTENT_NAME, USE_UV, USE_PV, USE_DUR, VISIT_UV, VISIT_PV
	-->
	
	<action name="subworkflow-use_visit_contet_term">
        <sub-workflow>
            <app-path>${nameNode}/user/hadoop/public/migu_analyo_ly/oozie/workflows/test/weekly_import_movie/use_visit_contet_term</app-path>
			<propagate-configuration/>
        </sub-workflow>
        <ok to="end"/>
        <error to="fail"/>
    </action>
    
	
	<!--OUTPUT_COLS : 
	COL:CONTENT_ID, 
	COL:CONTENT_NAME,
	COL:STATIS_DAY, COL:USE_UV, COL:USE_PV, COL:USE_DUR, COL:VISIT_UV, COL:VISIT_PV
	-->
	<action name="Lalign_content_use_visit">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
		
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>left_join_tool</arg>
			<arg>redNum=1</arg>
			
			<arg>startDate=${startDate}</arg>
			<arg>outDate=${startDate}</arg>
			
			<arg>outpath=${OutputPath}/daily</arg>
			
			<arg>inpath=${outputTmp}/tdim_prodId_videoType</arg>
			<arg>inpathR=${outputTmp}/content_use_visit</arg>
			
			<arg>mapCols=COL:CONTENT_ID, COL:CONTENT_NAME</arg>
			<arg>mapKeys=COL:CONTENT_ID</arg>
			<arg>mapVals=COL:CONTENT_NAME</arg>
			
			<arg>mapRCols=STATIS_DAY, CONTENT_ID, CONTENT_NAME, USE_UV, USE_PV, USE_DUR, VISIT_UV, VISIT_PV</arg>
				
			<arg>mapRKeys=COL:CONTENT_ID</arg>
			<arg>mapRVals=COL:STATIS_DAY NOT NULL, COL:USE_UV DEF ZERO, COL:USE_PV DEF ZERO, COL:USE_DUR DEF ZERO, COL:VISIT_UV DEF ZERO, COL:VISIT_PV DEF ZERO</arg>
			<capture-output />
		</java>
		<ok to="submitDatabase" />
		<error to="fail" />
	</action>
	
	
	<!--OUTPUT_COLS : 
	COL: AUTO_ REGISTER_DAY,
	COL:CONTENT_ID, 
	COL:CONTENT_NAME,
	COL:STATIS_DAY, COL:USE_UV, COL:USE_PV, COL:USE_DUR, COL:VISIT_UV, COL:VISIT_PV
	-->
	<action name="submitDatabase">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>mysql_table_submit</arg>
			<arg>inDate=${startDate}</arg>
			<arg>inpath=${OutputPath}/daily</arg>
			<arg>tableName=td_weekly_import_movie_use_detail</arg>
			<arg>tableColNum=9</arg>
			<capture-output />
		</java>
		<ok to="ava_content_use_visit" />
		<error to="fail" />
	</action>
	
	<!--OUTPUT_COLS : 
	COL:CONTENT_NAME, DATE:startDate,
	COL:USE_UV,    COL:USE_PV,    COL:USE_DUR,    COL:VISIT_UV, COL:VISIT_PV
	-->
	<action name="ava_content_use_visit">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<prepare>
				<delete path="${outputTmp}/ava_content_use_visit" />
			</prepare>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>mr_general_tool</arg>
			<arg>redNum=1</arg>
			
			
			<arg>startDate=${startDate}</arg>
			<arg>fromDate=${fromDate}</arg>
			<arg>outDate=${startDate}</arg>
			
			<arg>inpath=${OutputPath}/daily</arg>
			<arg>outpath=${OutputPath}/ava</arg>
			
			<arg>mapCols= COL:CONTENT_ID, COL:CONTENT_NAME, COL:STATIS_DAY, COL:USE_UV, COL:USE_PV, COL:USE_DUR, COL:VISIT_UV, COL:VISIT_PV</arg>
				
			<arg>mapKeys=COL:CONTENT_NAME, DATE:startDate</arg>
			<arg>mapVals=COL:USE_UV,    COL:USE_PV,    COL:USE_DUR,    COL:VISIT_UV, COL:VISIT_PV</arg>
			<arg>redVals=AVADAY:USE_UV, AVADAY:USE_PV, AVADAY:USE_DUR, AVADAY:VISIT_UV, AVADAY:VISIT_PV</arg>
			
			<capture-output />
		</java>
		<ok to="ava_submitDatabase" />
		<error to="fail" />
	</action>
	
	
	
	<!--OUTPUT_COLS : 	
	COL: AUTO_ REGISTER_DAY,
	COL:CONTENT_NAME, DATE:startDate,
	COL:USE_UV,    COL:USE_PV,    COL:USE_DUR,    COL:VISIT_UV, COL:VISIT_PV
	-->
	<action name="ava_submitDatabase">
		<java>
			<job-tracker>${jobTracker}</job-tracker>
			<name-node>${nameNode}</name-node>
			<configuration>
				<property>
					<name>mapred.job.queue.name</name>
					<value>${queue}</value>
				</property>
				<property>
					<name>mapred.child.java.opts</name>
					<value>-Xmx1024m</value>
				</property>
				<property>
					<name>mapred.reduce.tasks</name>
					<value>1</value>
				</property>
				<property>
					<name>NameNode</name>
					<value>${nameNode}</value>
				</property>
			</configuration>
			
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>mysql_table_submit</arg>
			<arg>inDate=${startDate}</arg>
			<arg>inpath=${OutputPath}/ava</arg>
			<arg>tableName=td_weekly_ava_import_movie_use_detail</arg>
			<arg>tableColNum=8</arg>
			<capture-output />
		</java>
		<ok to="end" />
		<error to="fail" />
	</action>

	<!--<action name="cleanTempData">
		<java>
			<prepare>
				<delete path="${outputTmp}" />
			</prepare>
			<main-class>com.mganaly.utils.MainRunner</main-class>
			<arg>cmd_del_path</arg>
			<arg>inpath=${outputTmp}</arg>
			<capture-output />
		</java>
		<ok to="end" />
		<error to="end" />
	</action>
	-->

	<kill name="fail">
		<message>Failed, error message[${wf:errorMessage(wf:lastErrorNode())}]
		</message>
	</kill>

	<end name="end" />
</workflow-app>
